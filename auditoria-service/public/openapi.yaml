openapi: 3.1.0
info:
  title: Auditoría Service API
  description: |
    API REST para el registro y consulta de eventos de auditoría del sistema FactuMarket.
    Este microservicio almacena todos los eventos de auditoría en MongoDB.

    ## Arquitectura
    - **Base de datos:** MongoDB (NoSQL)
    - **Comunicación:** HTTP REST (HTTParty desde otros servicios)
    - **Patrón:** Fire-and-forget (no bloquea operaciones principales)

    ## Ejemplos de uso con cURL

    ### 1. Registrar un evento de auditoría
    ```bash
    curl -X POST http://localhost:4003/auditoria \
      -H "Content-Type: application/json" \
      -d '{
        "entity_type": "Cliente",
        "entity_id": 1,
        "action": "CREATE",
        "details": "Cliente creado: Empresa ABC S.A.",
        "status": "SUCCESS"
      }'
    ```

    ### 2. Consultar eventos de un cliente específico
    ```bash
    curl http://localhost:4003/auditoria/cliente/1
    ```

    ### 3. Consultar eventos de una factura específica
    ```bash
    curl http://localhost:4003/auditoria/100
    ```

    ### 4. Listar eventos con filtros
    ```bash
    # Filtrar por acción CREATE
    curl "http://localhost:4003/auditoria?action=CREATE&limit=50"

    # Filtrar por estado SUCCESS
    curl "http://localhost:4003/auditoria?status=SUCCESS&limit=100"

    # Combinación de filtros
    curl "http://localhost:4003/auditoria?action=CREATE&status=ERROR&limit=20"
    ```

    ### 5. Health check
    ```bash
    curl http://localhost:4003/health
    ```

    ## Tipos de Acciones (action)
    - **CREATE:** Creación de una entidad
    - **READ:** Consulta de una entidad específica
    - **LIST:** Listado de entidades
    - **UPDATE:** Actualización de una entidad
    - **DELETE:** Eliminación de una entidad

    ## Estados (status)
    - **SUCCESS:** Operación exitosa
    - **ERROR:** Operación fallida
  version: 1.0.0
  contact:
    name: FactuMarket API Support
servers:
  - url: https://auditoria-ruby-double-v.ondeploy.space
    description: Servidor de producción
  - url: http://localhost:4003
    description: Servidor de desarrollo local
  - url: http://auditoria-service:4003
    description: Servidor Docker interno

tags:
  - name: auth
    description: Autenticación y generación de tokens JWT
  - name: auditoria
    description: Operaciones sobre eventos de auditoría
  - name: health
    description: Verificación de estado del servicio

security:
  - BearerAuth: []

paths:
  /auth/token:
    post:
      tags:
        - auth
      summary: Generar token JWT de prueba
      description: |
        Genera un token JWT válido para probar los endpoints protegidos desde Swagger UI.

        **Uso:**
        1. Ejecuta este endpoint
        2. Copia el token de la respuesta
        3. Click en "Authorize" (arriba a la derecha)
        4. Pega el token y click en "Authorize"
        5. Ahora puedes probar los demás endpoints

        **Nota:** El token expira en 5 minutos.
      operationId: generateToken
      security: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                service_name:
                  type: string
                  description: Nombre del servicio emisor (opcional)
                  example: swagger-test-client
      responses:
        '200':
          description: Token generado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Token generado exitosamente
                  token:
                    type: string
                    description: Token JWT para usar en Authorization header
                    example: eyJhbGciOiJIUzI1NiJ9...
                  expires_at:
                    type: string
                    format: date-time
                    example: "2025-01-13T12:05:00Z"
                  expires_in_seconds:
                    type: integer
                    example: 300
                  usage:
                    type: string
                    example: "Copia el token y úsalo en el botón 'Authorize' de Swagger UI"

  /auditoria:
    post:
      tags:
        - auditoria
      summary: Registrar un evento de auditoría
      description: Crea un nuevo evento de auditoría en MongoDB
      operationId: createAuditEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - entity_type
                - entity_id
                - action
              properties:
                entity_type:
                  type: string
                  description: Tipo de entidad auditada
                  enum: [Cliente, Factura]
                  example: Cliente
                entity_id:
                  type: integer
                  description: ID de la entidad auditada
                  example: 1
                action:
                  type: string
                  description: Acción realizada
                  enum: [CREATE, READ, UPDATE, DELETE, LIST]
                  example: CREATE
                details:
                  type: string
                  description: Descripción textual del evento
                  example: "Cliente creado: Empresa ABC S.A."
                status:
                  type: string
                  description: Estado del evento
                  enum: [SUCCESS, ERROR]
                  example: SUCCESS
                timestamp:
                  type: string
                  format: date-time
                  description: Timestamp del evento (opcional, se genera automáticamente si no se provee)
                  example: "2025-01-13T12:00:00Z"
      responses:
        '201':
          description: Evento de auditoría registrado exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Evento de auditoría registrado
                  data:
                    $ref: '#/components/schemas/AuditEvent'
              examples:
                cliente_creado:
                  summary: Cliente creado exitosamente
                  value:
                    success: true
                    message: "Evento de auditoría registrado"
                    data:
                      id: "507f1f77bcf86cd799439011"
                      entity_type: "Cliente"
                      entity_id: 1
                      action: "CREATE"
                      details: "Cliente creado: Empresa ABC S.A."
                      status: "SUCCESS"
                      timestamp: "2025-01-13T10:35:00Z"
                      created_at: "2025-01-13T10:35:00.123Z"
                factura_creada:
                  summary: Factura creada exitosamente
                  value:
                    success: true
                    message: "Evento de auditoría registrado"
                    data:
                      id: "507f1f77bcf86cd799439012"
                      entity_type: "Factura"
                      entity_id: 100
                      action: "CREATE"
                      details: "Factura creada con monto: 1500000"
                      status: "SUCCESS"
                      timestamp: "2025-01-13T10:36:00Z"
                      created_at: "2025-01-13T10:36:00.456Z"
        '400':
          description: Error de validación en los datos de entrada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                entity_type_vacio:
                  summary: entity_type requerido
                  value:
                    success: false
                    error: "entity_type es requerido"
                action_vacio:
                  summary: action requerido
                  value:
                    success: false
                    error: "action es requerido"
                details_vacio:
                  summary: details requerido
                  value:
                    success: false
                    error: "details es requerido"
                status_invalido:
                  summary: status inválido
                  value:
                    success: false
                    error: "status debe ser SUCCESS o ERROR"
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                error_mongodb:
                  summary: Error de conexión con MongoDB
                  value:
                    success: false
                    error: "Error al conectar con MongoDB"

    get:
      tags:
        - auditoria
      summary: Listar eventos de auditoría
      description: Obtiene eventos de auditoría con filtros opcionales por acción, estado o límite
      operationId: listAuditEvents
      parameters:
        - name: action
          in: query
          required: false
          description: Filtrar por acción específica
          schema:
            type: string
            enum: [CREATE, READ, UPDATE, DELETE, LIST]
            example: CREATE
        - name: status
          in: query
          required: false
          description: Filtrar por estado del evento
          schema:
            type: string
            enum: [SUCCESS, ERROR]
            example: SUCCESS
        - name: limit
          in: query
          required: false
          description: Número máximo de eventos a retornar
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
            example: 50
      responses:
        '200':
          description: Lista de eventos de auditoría obtenida exitosamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditEvent'
                  count:
                    type: integer
                    description: Número de eventos retornados
                    example: 50
              examples:
                lista_eventos:
                  summary: Lista de eventos de auditoría
                  value:
                    success: true
                    count: 3
                    data:
                      - id: "507f1f77bcf86cd799439011"
                        entity_type: "Cliente"
                        entity_id: 1
                        action: "CREATE"
                        details: "Cliente creado: Empresa ABC S.A."
                        status: "SUCCESS"
                        timestamp: "2025-01-13T10:35:00Z"
                        created_at: "2025-01-13T10:35:00.123Z"
                      - id: "507f1f77bcf86cd799439012"
                        entity_type: "Factura"
                        entity_id: 100
                        action: "CREATE"
                        details: "Factura creada con monto: 1500000"
                        status: "SUCCESS"
                        timestamp: "2025-01-13T10:36:00Z"
                        created_at: "2025-01-13T10:36:00.456Z"
                      - id: "507f1f77bcf86cd799439013"
                        entity_type: "Cliente"
                        entity_id: 1
                        action: "READ"
                        details: "Cliente consultado: Empresa ABC S.A."
                        status: "SUCCESS"
                        timestamp: "2025-01-13T10:37:00Z"
                        created_at: "2025-01-13T10:37:00.789Z"
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auditoria/{factura_id}:
    get:
      tags:
        - auditoria
      summary: Obtener eventos de auditoría por factura
      description: Recupera todos los eventos de auditoría asociados a una factura específica
      operationId: getAuditEventsByFactura
      parameters:
        - name: factura_id
          in: path
          required: true
          description: ID de la factura
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Eventos encontrados
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditEvent'
                  count:
                    type: integer
                    example: 5
              examples:
                eventos_factura:
                  summary: Eventos de una factura específica
                  value:
                    success: true
                    count: 2
                    data:
                      - id: "507f1f77bcf86cd799439014"
                        entity_type: "Factura"
                        entity_id: 100
                        action: "CREATE"
                        details: "Factura creada con monto: 1500000"
                        status: "SUCCESS"
                        timestamp: "2025-01-13T10:40:00Z"
                        created_at: "2025-01-13T10:40:00.123Z"
                      - id: "507f1f77bcf86cd799439015"
                        entity_type: "Factura"
                        entity_id: 100
                        action: "READ"
                        details: "Factura consultada con ID: 100"
                        status: "SUCCESS"
                        timestamp: "2025-01-13T10:45:00Z"
                        created_at: "2025-01-13T10:45:00.456Z"
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auditoria/cliente/{cliente_id}:
    get:
      tags:
        - auditoria
      summary: Obtener eventos de auditoría por cliente
      description: Recupera todos los eventos de auditoría asociados a un cliente específico
      operationId: getAuditEventsByCliente
      parameters:
        - name: cliente_id
          in: path
          required: true
          description: ID del cliente
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Eventos encontrados
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/AuditEvent'
                  count:
                    type: integer
                    example: 10
              examples:
                eventos_cliente:
                  summary: Eventos de un cliente específico
                  value:
                    success: true
                    count: 3
                    data:
                      - id: "507f1f77bcf86cd799439016"
                        entity_type: "Cliente"
                        entity_id: 1
                        action: "CREATE"
                        details: "Cliente creado: Empresa ABC S.A."
                        status: "SUCCESS"
                        timestamp: "2025-01-13T09:00:00Z"
                        created_at: "2025-01-13T09:00:00.123Z"
                      - id: "507f1f77bcf86cd799439017"
                        entity_type: "Cliente"
                        entity_id: 1
                        action: "READ"
                        details: "Cliente consultado: Empresa ABC S.A."
                        status: "SUCCESS"
                        timestamp: "2025-01-13T09:15:00Z"
                        created_at: "2025-01-13T09:15:00.456Z"
                      - id: "507f1f77bcf86cd799439018"
                        entity_type: "Cliente"
                        entity_id: 1
                        action: "READ"
                        details: "Cliente consultado: Empresa ABC S.A."
                        status: "SUCCESS"
                        timestamp: "2025-01-13T09:30:00Z"
                        created_at: "2025-01-13T09:30:00.789Z"
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /health:
    get:
      tags:
        - health
      summary: Verificar estado del servicio
      description: Endpoint para verificar que el servicio está funcionando correctamente
      operationId: healthCheck
      responses:
        '200':
          description: Servicio funcionando correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  service:
                    type: string
                    example: auditoria-service
                  status:
                    type: string
                    example: running
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-01-13T12:00:00Z"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Autenticación JWT requerida para todas las operaciones (excepto /health y /docs).

        **Token de prueba:**
        ```
        eyJhbGciOiJIUzI1NiJ9.eyJzZXJ2aWNlX25hbWUiOiJ0ZXN0LWNsaWVudCIsImlhdCI6MTc2MzE4MDc4MiwiZXhwIjoxNzYzMTg0MzgyfQ.ggNaB3L8E-wUHS34rskyeQuD3N42DWiyjRz5CTCqQFY
        ```

  schemas:
    AuditEvent:
      type: object
      properties:
        id:
          type: string
          description: ID único del evento (MongoDB ObjectId)
          example: "507f1f77bcf86cd799439011"
        entity_type:
          type: string
          description: Tipo de entidad auditada
          enum: [Cliente, Factura]
          example: Cliente
        entity_id:
          type: integer
          description: ID de la entidad auditada
          example: 1
        action:
          type: string
          description: Acción realizada
          enum: [CREATE, READ, UPDATE, DELETE, LIST]
          example: CREATE
        details:
          type: string
          description: Descripción textual del evento
          example: "Cliente creado: Empresa ABC S.A."
        status:
          type: string
          description: Estado del evento
          enum: [SUCCESS, ERROR]
          example: SUCCESS
        timestamp:
          type: string
          format: date-time
          description: Timestamp del evento (ISO 8601)
          example: "2025-01-13T10:35:00Z"
        created_at:
          type: string
          format: date-time
          description: Fecha de creación del evento en la base de datos
          example: "2025-01-13T10:35:00.123Z"

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Mensaje de error
          example: Error al registrar evento de auditoría
