services:
  # MongoDB for Auditoría Service
  mongodb:
    image: mongo:7.0
    container_name: factumarket-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-auditoria_db}
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-factumarket_secure_2025}
    volumes:
      - mongodb_data:/data/db
    networks:
      - factumarket-network

  # Auditoría Service
  auditoria-service:
    build:
      context: .
      dockerfile: ./auditoria-service/Dockerfile
    container_name: factumarket-auditoria
    restart: unless-stopped
    ports:
      - "${AUDITORIA_PORT:-4003}:${AUDITORIA_PORT:-4003}"
    env_file:
      - ./.env
    environment:
      # Only override if not set in .env or system environment
      - PORT=${AUDITORIA_PORT:-4003}
      - MONGO_URL=${MONGO_URL:-mongodb:27017}
      - MONGO_DATABASE=${MONGO_DATABASE:-auditoria_db}
      - MONGO_USERNAME=${MONGO_USERNAME:-admin}
      - MONGO_PASSWORD=${MONGO_PASSWORD:-factumarket_secure_2025}
      - RACK_ENV=${RACK_ENV:-development}
    depends_on:
      - mongodb
    volumes:
      - ./auditoria-service:/app
    networks:
      - factumarket-network
    command: bundle exec puma config.ru -p ${AUDITORIA_PORT:-4003} -e ${RACK_ENV:-development}

  # Clientes Service
  clientes-service:
    build:
      context: .
      dockerfile: ./clientes-service/Dockerfile
    container_name: factumarket-clientes
    restart: unless-stopped
    ports:
      - "${CLIENTES_PORT:-4001}:${CLIENTES_PORT:-4001}"
    env_file:
      - ./.env
    environment:
      # Only override if not set in .env or system environment
      - PORT=${CLIENTES_PORT:-4001}
      - DATABASE_URL=${CLIENTES_DATABASE_URL:-sqlite3:db/clientes.sqlite3}
      - AUDITORIA_SERVICE_URL=${AUDITORIA_SERVICE_URL:-http://auditoria-service:${AUDITORIA_PORT:-4003}}
      - RACK_ENV=${RACK_ENV:-development}
      # JWT Configuration
      - SERVICE_NAME=clientes-service
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      auditoria-service:
        condition: service_started
    volumes:
      - ./clientes-service:/app
      - ./shared:/app/shared
    networks:
      - factumarket-network
    command: >
      sh -c "bundle exec rake db:migrate &&
             bundle exec puma config.ru -p ${CLIENTES_PORT:-4001} -e ${RACK_ENV:-development}"

  # Facturas Service
  facturas-service:
    build:
      context: .
      dockerfile: ./facturas-service/Dockerfile
    container_name: factumarket-facturas
    restart: unless-stopped
    ports:
      - "${FACTURAS_PORT:-4002}:${FACTURAS_PORT:-4002}"
    env_file:
      - ./.env
    environment:
      # Only override if not set in .env or system environment
      - PORT=${FACTURAS_PORT:-4002}
      - DATABASE_URL=${FACTURAS_DATABASE_URL:-sqlite3:db/facturas.sqlite3}
      - CLIENTES_SERVICE_URL=${CLIENTES_SERVICE_URL:-http://clientes-service:${CLIENTES_PORT:-4001}}
      - AUDITORIA_SERVICE_URL=${AUDITORIA_SERVICE_URL:-http://auditoria-service:${AUDITORIA_PORT:-4003}}
      - RACK_ENV=${RACK_ENV:-development}
      # JWT Configuration
      - SERVICE_NAME=facturas-service
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      clientes-service:
        condition: service_started
      auditoria-service:
        condition: service_started
    volumes:
      - ./facturas-service:/app
      - ./shared:/app/shared
    networks:
      - factumarket-network
    command: >
      sh -c "bundle exec rake db:migrate &&
             bundle exec puma config.ru -p ${FACTURAS_PORT:-4002} -e ${RACK_ENV:-development}"

networks:
  factumarket-network:
    driver: bridge

volumes:
  mongodb_data:
