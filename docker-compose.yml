services:
  # MongoDB for Auditoría Service
  mongodb:
    image: mongo:7.0
    container_name: factumarket-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: auditoria_db
    volumes:
      - mongodb_data:/data/db
    networks:
      - factumarket-network

  # Auditoría Service
  auditoria-service:
    build:
      context: ./auditoria-service
      dockerfile: Dockerfile
    container_name: factumarket-auditoria
    restart: unless-stopped
    ports:
      - "${AUDITORIA_PORT:-4003}:${AUDITORIA_PORT:-4003}"
    env_file:
      - ./.env
    environment:
      # Only override if not set in .env or system environment
      - PORT=${AUDITORIA_PORT:-4003}
      - MONGO_URL=${MONGO_URL:-mongodb:27017}
      - MONGO_DATABASE=${MONGO_DATABASE:-auditoria_db}
      - RACK_ENV=${RACK_ENV:-development}
    depends_on:
      - mongodb
    volumes:
      - ./auditoria-service:/app
    networks:
      - factumarket-network
    command: bundle exec puma config.ru -p ${AUDITORIA_PORT:-4003} -e ${RACK_ENV:-development}

  # Clientes Service
  clientes-service:
    build:
      context: ./clientes-service
      dockerfile: Dockerfile
    container_name: factumarket-clientes
    restart: unless-stopped
    ports:
      - "${CLIENTES_PORT:-4001}:${CLIENTES_PORT:-4001}"
    env_file:
      - ./.env
    environment:
      # Only override if not set in .env or system environment
      - PORT=${CLIENTES_PORT:-4001}
      - DATABASE_URL=${CLIENTES_DATABASE_URL:-sqlite3:db/clientes.sqlite3}
      - AUDITORIA_SERVICE_URL=${AUDITORIA_SERVICE_URL:-http://auditoria-service:${AUDITORIA_PORT:-4003}}
      - RACK_ENV=${RACK_ENV:-development}
    depends_on:
      - auditoria-service
    volumes:
      - ./clientes-service:/app
    networks:
      - factumarket-network
    command: >
      sh -c "bundle exec rake db:migrate &&
             bundle exec puma config.ru -p ${CLIENTES_PORT:-4001} -e ${RACK_ENV:-development}"

  # Facturas Service
  facturas-service:
    build:
      context: ./facturas-service
      dockerfile: Dockerfile
    container_name: factumarket-facturas
    restart: unless-stopped
    ports:
      - "${FACTURAS_PORT:-4002}:${FACTURAS_PORT:-4002}"
    env_file:
      - ./.env
    environment:
      # Only override if not set in .env or system environment
      - PORT=${FACTURAS_PORT:-4002}
      - DATABASE_URL=${FACTURAS_DATABASE_URL:-sqlite3:db/facturas.sqlite3}
      - CLIENTES_SERVICE_URL=${CLIENTES_SERVICE_URL:-http://clientes-service:${CLIENTES_PORT:-4001}}
      - AUDITORIA_SERVICE_URL=${AUDITORIA_SERVICE_URL:-http://auditoria-service:${AUDITORIA_PORT:-4003}}
      - RACK_ENV=${RACK_ENV:-development}
    depends_on:
      - clientes-service
      - auditoria-service
    volumes:
      - ./facturas-service:/app
    networks:
      - factumarket-network
    command: >
      sh -c "bundle exec rake db:migrate &&
             bundle exec puma config.ru -p ${FACTURAS_PORT:-4002} -e ${RACK_ENV:-development}"

networks:
  factumarket-network:
    driver: bridge

volumes:
  mongodb_data:
